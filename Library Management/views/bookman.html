<head>
	
	<script type="text/javascript">
	$(document).ready(function() {
		function buttonNode(node, book) {
			var editbutton = $("<button></button>")
			editbutton.addClass("edit-button btn btn-warning")
			editbutton.append("<i class='icon-pencil'></i>")
			$(editbutton).data("book-id", book.id)
			attach_events_for_edit_button($(editbutton))
			var deletebutton = $("<button></button>")
			deletebutton.addClass("delete-button btn btn-danger")
			deletebutton.append("<i class='icon-remove'></i>")
			$(deletebutton).data("book-id", book.id)
			attach_events_for_delete_button($(deletebutton))
			var checkoutbutton = $("<button></button>")
			checkoutbutton.addClass("completed-button btn btn-success")
			checkoutbutton.append("<i class='icon-ok'></i>")
			$(checkoutbutton).data("book-id", book.id)
			attach_events_for_checkout_button($(checkoutbutton))
			node.append(checkoutbutton)
			node.append(editbutton)
			node.append(deletebutton)
		}

		function updateTable() {
			$.ajax({
				type: "GET",
				contentType: "application/json",
				url: "/books.json",
				success: function(books_json) {
					$("tr.removable").remove()
					var books = JSON.parse(books_json)
					var checkoutbooks = []
					for(var i in books) {
						book = books[i]
						if(!book.checkout) {
							var node = $("<td></td>")
							buttonNode(node, book)
							if(i%2 == 0) {
								$('#book-table').append("<tr class=\"removable\">\n<td>" + i + "" + book.title +"</td>\n<td>" + book.author + "</td>\n<td>" + book.publisher + "</td>\n</tr>")
								$('#book-table tr:last').append(node)
							}
							else {
								$('#book-table').append("<tr class=\"alt removable\">\n<td>" + i + "" + book.title +"</td>\n<td>" + book.author + "</td>\n<td>" + book.publisher + "</td>\n</tr>")
								$('#book-table tr:last').append(node)
							}
						}
						else {
							checkoutbooks.push(book)
						}
					}

					for(var i in checkoutbooks) {
						var book = checkoutbooks[i]
						var checkoutData = {}
						$.ajax({
							type: "GET",
							contentType: "application/json",
							url: "/checkout/book/" + book.id + ".json",
							success: function(checkout_json) {
								checkout = JSON.parse(checkout_json)
								checkoutData["book_title"] = checkout[0].book_title
								checkoutData["cust_name"] = checkout[0].cust_name
								checkoutData["publisher"] = checkout[0].publisher
								checkoutData["author"] = checkout[0].author
								checkoutData["return_date"] = checkout[0].return_date
								$('#checkout-book-table').append("<tr class=\"removable\">\n<td>" + checkoutData["book_title"] +"</td>\n<td>" + checkoutData["author"][0]["name"] + "</td>\n<td>" + checkoutData["publisher"] + "</td>\n<td>" + checkoutData["cust_name"] + "</td>\n<td>" + checkoutData["return_date"] + "</td>\n</tr>")
							}
						})
					}
				}
			})
		}

		updateTable()


		$("#create-btn").click(function() {
			var titletext = $("#titletext").val()
			var authortext = $("#authortext").val()
			var publishertext = $("#publishertext").val()

			$("#titletext").val("")
			$("#authortext").val("")
			$("#publishertext").val("")

			$.ajax({
				type: "POST",
				url: "/books.json",
				data: {
					book:JSON.stringify({
						title: titletext,
						author: authortext,
						publisher: publishertext
					})
				},
				success: function() {
					updateTable()
				}
			})
		})

		function attach_events_for_edit_button(node) {
			$(node).click(function() {
				var content = prompt("What is the book's title?", "")
				$.ajax({
					type: "PUT",
					url: "/book/" + $(node).data("book-id") +".json",
					data: {
						newcontent: content
					},
					success: function() {
						updateTable()
					},
					error: function() {
					}
				})
			})
		}

		function attach_events_for_delete_button(node) {
			$(node).click(function() {
				var conf = confirm("Are you sure you wish to delete this book?")
				if(conf == true) {
					$.ajax({
						type: "DELETE",
						url: "/book/" + $(node).data("book-id") +".json",
						success: function() {
							updateTable()
						},
						error: function() {
						}
					})
				}
			})
		}

		function attach_events_for_checkout_button(node) {
			$(node).click(function() {
				$.ajax({
					type: "POST",
					url: "/checkout.json",
					data: {
						checkout:JSON.stringify({
							book_id: $(node).data("book-id")
						})
					},
					success: function() {
						updateTable()
					},
					error: function(error) {
						$("#error-area").html(error[1]["error"])
					}
				})
			})
		}


	})

	</script>
</head>
<body>
	<div id="content-body">
		<div id="book-list">
			<h2>Available Books</h2>
			<table id="book-table" border="1">
				<tr class="save">
					<th style = "width: 30%">Title</th>
					<th style = "width: 30%">Author</th>
					<th style = "width: 27%">Publisher</th>
					<th style = "width: 13%">Edit/Delete</th>
				</tr>
				<tr>
					<td><input type="text" placeholder="Book title" id="titletext" style = "width: 95%; margin-bottom: 0px"></td>
					<td><input type="text" placeholder="Book author" id="authortext" style = "width: 95%; margin-bottom: 0px"></td>
					<td><input type="text" placeholder="Book publisher" id="publishertext" style = "width: 95%; margin-bottom: 0px"></td>
					<td><button type="btn" id="create-btn" style= "width: 96%">Add Book</button></td>
				</tr>
			</table>

			<br /><h2>Checked Out Books</h2>
			<table id="checkout-book-table" border="1">
				<tr class="save">
					<th style = "width: 30%">Title</th>
					<th style = "width: 30%">Author</th>
					<th style = "width: 20%">Publisher</th>
					<th style = "width: 10%">Checked out by</th>
					<th style = "width: 10%">Return date</th>
				</tr>
			</table> <br><br><br>
		</div>
	</div>
</body>