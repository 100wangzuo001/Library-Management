<head>
	
	<script type="text/javascript">
	$(document).ready(function() {
		
		function addcolorbox() {
			$(".inline").colorbox({inline:true, width:"50%", href: "#inline_content"});
		}
		
		function buttonNode(node, book) {
			var editbutton = $("<button></button>")
			editbutton.addClass("edit-button btn btn-warning inline cboxElement")
//			editbutton.attr("href", "#inline_content")
			editbutton.append("<i class='icon-pencil'></i>")
			$(editbutton).data("book-id", book.id)
			var deletebutton = $("<button></button>")
			deletebutton.addClass("delete-button btn btn-danger")
			deletebutton.append("<i class='icon-remove'></i>")
			$(deletebutton).data("book-id", book.id)
			attach_events_for_delete_button($(deletebutton))
			node.append(editbutton)
			node.append(deletebutton)
		}

		function updateTable() {
			$.ajax({
				type: "GET",
				contentType: "application/json",
				url: "/books.json",
				success: function(books_json) {
					$("tr.removable").remove()
					var books = JSON.parse(books_json)
					var checkoutbooks = []
					var j = 0
					for(var i in books) {
						book = books[i]
						console.log(book.checkout)
						if(!book.checkout) {
							var node = $("<td></td>")
							buttonNode(node, book)
							if(j%2 == 0) {
								$('#book-table').append("<tr class=\"removable\">\n<td>" + book.title +"</td>\n<td>" + book.author + "</td>\n<td>" + book.publisher + "</td>\n</tr>")
								$('#book-table tr:last').append(node)
							}
							else {
								$('#book-table').append("<tr class=\"alt removable\">\n<td>" + book.title +"</td>\n<td>" + book.author + "</td>\n<td>" + book.publisher + "</td>\n</tr>")
								$('#book-table tr:last').append(node)
							}
							j++;
						}
						else {
							checkoutbooks.push(book)
						}
					}
					var j = 0
					for(var i in checkoutbooks) {
						var book = checkoutbooks[i]
						var checkoutData = {}
						$.ajax({
							type: "GET",
							contentType: "application/json",
							url: "/checkout/book/" + book.id + ".json",
							success: function(checkout_json) {
								checkout = JSON.parse(checkout_json)
								checkoutData["book_title"] = checkout[0].book_title
								checkoutData["cust_name"] = checkout[0].cust_name
								checkoutData["publisher"] = checkout[0].publisher
								checkoutData["author"] = checkout[0].author
								checkoutData["return_date"] = checkout[0].return_date
								if (j%2 ==0) {
									$('#checkout-book-table').append("<tr class=\"removable\">\n<td>" + checkoutData["book_title"] +"</td>\n<td>" + checkoutData["author"][0]["name"] + "</td>\n<td>" + checkoutData["publisher"] + "</td>\n<td>" + checkoutData["cust_name"] + "</td>\n<td>" + checkoutData["return_date"] + "</td>\n</tr>")
									j++;
								} else {
									$('#checkout-book-table').append("<tr class=\"alt removable\">\n<td>" + checkoutData["book_title"] +"</td>\n<td>" + checkoutData["author"][0]["name"] + "</td>\n<td>" + checkoutData["publisher"] + "</td>\n<td>" + checkoutData["cust_name"] + "</td>\n<td>" + checkoutData["return_date"] + "</td>\n</tr>")
									j++;
								}
							}
						})
					}
					addcolorbox()
				},
				error: function() {
					
				}
			})
		}

		updateTable()


		$("#add-book-form").submit(function() {
			var titletext = $("#titletext").val()
			var authortext = $("#authortext").val()
			var publishertext = $("#publishertext").val()

			$("#titletext").val("")
			$("#authortext").val("")
			$("#publishertext").val("")

			$.ajax({
				type: "POST",
				url: "/books.json",
				data: {
					book:JSON.stringify({
						title: titletext,
						author: authortext,
						publisher: publishertext
					})
				},
				success: function() {
					updateTable()
				}
			})
			return false;
		})

		function attach_events_for_edit_button(node) {
			$(node).click(function() {
				var content = prompt("What is the book's title?", "")
				$.ajax({
					type: "PUT",
					url: "/book/" + $(node).data("book-id") +".json",
					data: {
						newcontent: content
					},
					success: function() {
						updateTable()
					},
					error: function() {
					}
				})
			})
		}

		function attach_events_for_delete_button(node) {
			$(node).click(function() {
				var conf = confirm("Are you sure you wish to delete this book?")
				if(conf == true) {
					$.ajax({
						type: "DELETE",
						url: "/book/" + $(node).data("book-id") +".json",
						success: function() {
							updateTable()
						},
						error: function() {
						}
					})
				}
			})
		}

	})

	</script>
</head>
<body>
	<div id="content-body">
		<div id="book-list">
			<h3>Available Books</h3>
			<table id="book-table" border="1">
				<tr class="save">
					<th style = "width: 30%">Title</th>
					<th style = "width: 30%">Author</th>
					<th style = "width: 27%">Publisher</th>
					<th style = "width: 13%">Action</th>
				</tr>
				<tr>
					<td><form id="add-book-form"><input type="text" placeholder="Book title" id="titletext" style = "width: 95%; margin-bottom: 0px"></td>
					<td><input type="text" placeholder="Book author" id="authortext" style = "width: 95%; margin-bottom: 0px"></td>
					<td><input type="text" placeholder="Book publisher" id="publishertext" style = "width: 95%; margin-bottom: 0px"></td>
					<td><input type="submit" id="create-btn" style= "width: 96%" value="Add Book"></button></form></td>
				</tr>
			</table>

			<br /><h3>Checked Out Books</h3>
			<table id="checkout-book-table" border="1">
				<tr class="save">
					<th style = "width: 25%">Title</th>
					<th style = "width: 25%">Author</th>
					<th style = "width: 15%">Publisher</th>
					<th style = "width: 15%">Checked Out By</th>
					<th style = "width: 15%">Return Date</th>
				</tr>
			</table>
		</div>
	</div>
	<a class='inline'>Inline HTML</a>
	<div style="display:none">
		<div id='inline_content' style='padding:10px; background:#fff;'>
		<p><strong>This content comes from a hidden element on this page.</strong></p>
		<p>The inline option preserves bound JavaScript events and changes, and it puts the content back where it came from when it is closed.</p>
		<p><a id="click" href="#" style='padding:5px; background:#ccc;'>Click me, it will be preserved!</a></p>
		
		<p><strong>If you try to open a new ColorBox while it is already open, it will update itself with the new content.</strong></p>
		<p>Updating Content Example:<br />
		<a class="ajax" href="../content/flash.html">Click here to load new content</a></p>
		</div>
	</div>
</body>